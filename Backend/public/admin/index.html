<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Submissions Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-new { background-color: #f8d7da; }
        .status-in-progress { background-color: #fff3cd; }
        .status-completed { background-color: #d1e7dd; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col">
                <h1>Contact Form Submissions</h1>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col">
                <div class="input-group">
                    <input type="password" id="apiKeyInput" class="form-control" placeholder="Enter your API key">
                    <button class="btn btn-primary" id="loadDataBtn">Load Submissions</button>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Company</th>
                                <th>Service</th>
                                <th>Project Details</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="submissionsTable">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="submissionId">
                    <select class="form-select" id="statusSelect">
                        <option value="new">New</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="updateStatusBtn">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this submission?</p>
                    <input type="hidden" id="deleteSubmissionId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let apiKey = '';
        let statusModal, deleteModal;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap modals
            statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            
            // Load data button click
            document.getElementById('loadDataBtn').addEventListener('click', function() {
                apiKey = document.getElementById('apiKeyInput').value.trim();
                if (apiKey) {
                    loadSubmissions();
                } else {
                    alert('Please enter your API key');
                }
            });
            
            // Update status button click
            document.getElementById('updateStatusBtn').addEventListener('click', function() {
                const id = document.getElementById('submissionId').value;
                const status = document.getElementById('statusSelect').value;
                updateStatus(id, status);
            });
            
            // Confirm delete button click
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                const id = document.getElementById('deleteSubmissionId').value;
                deleteSubmission(id);
            });
        });
        
        // Load all submissions
        async function loadSubmissions() {
            try {
                const response = await fetch('/api/contact', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load submissions');
                }
                
                displaySubmissions(data.data);
            } catch (error) {
                alert('Error: ' + error.message);
                console.error(error);
            }
        }
        
        // Display submissions in the table
        function displaySubmissions(submissions) {
            const tableBody = document.getElementById('submissionsTable');
            tableBody.innerHTML = '';
            
            submissions.forEach(submission => {
                const row = document.createElement('tr');
                row.className = `status-${submission.status}`;
                
                const date = new Date(submission.createdAt).toLocaleString();
                
                row.innerHTML = `
                    <td>${escapeHtml(submission.fullName)}</td>
                    <td>${escapeHtml(submission.email)}</td>
                    <td>${escapeHtml(submission.company || '-')}</td>
                    <td>${escapeHtml(submission.serviceInterested || '-')}</td>
                    <td>${escapeHtml(submission.projectDetails)}</td>
                    <td>${date}</td>
                    <td>${capitalizeFirstLetter(submission.status)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary update-btn" data-id="${submission._id}">Update</button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${submission._id}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.update-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    document.getElementById('submissionId').value = id;
                    statusModal.show();
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    document.getElementById('deleteSubmissionId').value = id;
                    deleteModal.show();
                });
            });
        }
        
        // Update submission status
        async function updateStatus(id, status) {
            try {
                const response = await fetch(`/api/contact/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update status');
                }
                
                statusModal.hide();
                loadSubmissions();
            } catch (error) {
                alert('Error: ' + error.message);
                console.error(error);
            }
        }
        
        // Delete submission
        async function deleteSubmission(id) {
            try {
                const response = await fetch(`/api/contact/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete submission');
                }
                
                deleteModal.hide();
                loadSubmissions();
            } catch (error) {
                alert('Error: ' + error.message);
                console.error(error);
            }
        }
        
        // Helper functions
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }
        
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</body>
</html>